---

layout: post

title: "DVWA笔记5（file upload）"

author: "markt"

---


## 源码分析

这次就不贴源码了，反正很容易搜到。

简单来说，由简至难由low至impossible的策略如下：

| low        | 基本没有防护，仅仅检查是否上传成功                           |
| ---------- | ------------------------------------------------------------ |
| medium     | 增加简单限制文件格式为jpeg和png，以及大小<100000             |
| high       | 改变限制策略，从右至左来手工截取后缀，增加了jpg的格式，采用内置函数限制文件格式为图片（否则报错） |
| impossible | 加入CSRF token机制，用将文件名与随机值连接后md5加密的方法重命名临时文件，采用特定函数来检测文件内容 |

## 渗透策略

基于此：

| low        | 直接上传shell                                                |
| ---------- | ------------------------------------------------------------ |
| medium     | 1. 采用%00截断的方式（php版本在5.3.4以下且当Magic_quote_gpc选项为off时） |
|            | 2.抓包修改传至服务器的文件类型值                             |
| high       | 利用linux的copy命令来向图片中插入shell，然后利用文件包含的漏洞连接shell |
| impossible | 网上没有找到解决方法。如果单单是从文件名进行限制的话，可以先扫描上传路径，然后逐个尝试连接……但是如果用比较仔细的对文件**内容**检查的函数来检查上传文件的话，基本上杜绝了文件上传的漏洞 |

## webshell连接软件：

windows下：中国菜刀；

linux下：CKnife，webacoo，weevely

## 实践：

### low

花式随便上传

### medium

上传时抓包，修改文件类型值为image/jpeg然后转发，然后直接连接菜刀即可。这里我用的是weevely，虽然只支持php但是很好使。

### high

企图直接修改后缀名然后利用文件包含漏洞，上传失败；

简单利用cp命令生成后门，失败；getimagesize(string filename)函数会通过读取文件头，返回图片的长、宽等信息，如果没有相关的图片文件头，函数会报错。

在php5.3.4之前当Magic_quote_gpc选项为off时可以用的%00截断，失败；版本。

但是！！！

按教程试了一下在windows下用copy命令合成图片木马确可以绕过？普通的copy不行还得加什么/b/a的参数？什么鬼？

……

好吧破案了。/b是以二进制打开，/a是以asc码文件打开。。。

**而且**，由于真的上传上去的是一个图片格式的文件，所以好像还不能直接连接菜刀，而是需要用到文件包含的漏洞。

